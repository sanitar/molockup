/**
 * Created by .
 * User: pan
 * Date: 21.06.11
 * Time: 22:40
 */
(function(a){a.widget("ui.mblock",{options:{title:"Mblock",block_type:"simple",block_id:0,layer_id:0,content:"Empty block",donor:!1,height:150,width:150,blockpool:!1},_create:function(){this.options.block_type=a("#block_type").val(),this.init_block(),this.options.blockpool&&molockup.blockpool[this.options.blockpool].action(this.element.content)},init_block:function(){this.block_element=this.element,this.block_id=molockup.block_id++||this.options.block_id,this.layer_id=this.options.layer_id,this.block_type=this.options.block_type,this.navigation=a("#navigation"),this.workspace=a("#work_space"),this.ctrl={},this.debug=a("#debug"),this._create_block(),molockup.blocks["element_"+this.block_id]=this},_create_block:function(){this.block_content=a("<div/>",{"class":"content"}),this.element.addClass("layer_"+this.layer_id),this.element.attr("id","element_"+this.block_id);if(this.options.donor){var b=this.options.donor.settings;this.element.settings={id:"element_"+this.block_id,width:b.width,height:b.height,left:b.left,top:b.top,type:b.type,content_html:b.content_html},this.block_content.append(b.content_html)}else this.element.settings={id:"element_"+this.next_id,width:this.options.width,height:this.options.height,left:this.navigation.position().left+this.navigation.width()+20,top:0,type:this.options.block_type,content_html:this.options.content},this.block_content.append(this.options.content);this.block_content.addClass(this.element.settings.type),this.element.append(this.block_content),this.element.content=this.block_content,this.element.draggable(this._draggable_options()),this.element.resizable(this._resizable_options());var c=this;this.element.click(function(){return a(".ui-selected").removeClass("ui-selected"),a(this).addClass("ui-selected"),molockup.condition.block=this,flash("update_info_panel"),!1}),this.element.hover(function(){a(this).addClass("hovered")},function(){a(this).removeClass("hovered")}),this.element.addClass("element").css({position:"absolute",width:this.element.settings.width,height:this.element.settings.height,left:this.element.settings.left+20,top:this.element.settings.top+20}),this.element.appendTo(this.workspace),this._render_triggers(),this.update_element_info()},update_element_info:function(){return this.element.settings={width:this.element.width(),height:this.element.height(),left:this.element.position().left,top:this.element.position().top,content_html:this.element.content.html(),type:this.element.settings.type},!0},_resizable_options:function(){var a=this,b="parent",c={handles:"n, e, s, w, se",containment:b,grid:5,stop:function(b,c){a.update_element_info()}};return c},_draggable_options:function(){var b=this,c="parent",d=a([]),e={top:0,left:0},f={containment:c,grid:[5,5],scroll:!0,stop:function(a,c){b.update_element_info()},start:function(c,f){d=b.workspace.children(".ui-selected").each(function(){var b=a(this);b.data("offset",b.offset())}),e=a(this).offset()},drag:function(c,f){if(b.element.hasClass("ui-selected")){var g=f.position.top-e.top,h=f.position.left-e.left;d.not(b.element).each(function(){var b=a(this),c=b.data("offset");b.css({top:c.top+g,left:c.left+h})})}}};return f},_init_default_triggers:function(){var b=this;this.ctrl.triggers={close:{handler:a("<div/>",{"class":"close_trigger"}),action:function(){return b.element.remove(),!1}},clone:{handler:a("<div/>",{"class":"insert_trigger"}),action:function(){return a("<div/>").mblock({donor:b.element}),!1}},options:{handler:a("<div/>",{"class":"options_trigger"}),action:function(){return b.debug.text(JSON.stringify(b.element)),b._render_ctrl_content(),!1}},select:{handler:a("<div/>",{"class":"select_trigger"}),action:function(){return!1}},lock:{handler:a("<div/>",{"class":"lock_trigger"}),action:function(){return b.element.resizable("option","disabled")?b.element.resizable("option","disabled",!1):b.element.resizable("option","disabled",!0),a(this).toggleClass("locked"),!1}}}},_render_triggers:function(){var b=this;return this._init_default_triggers(),a.each(this.ctrl.triggers,function(){var c=this.event?this.event:"click";b.element.append(a(this.handler)),this.handler.bind(c,this.action)}),!1},_render_ctrl_content:function(){var b=this;return molockup.content_menu.html(""),a.each(molockup.blockpool,function(){var c=a("<a/>").attr("href","#").html(this.title);molockup.content_menu.append(c),c.wrap("<li/>");var d=this;c.click(function(){d.action(b.element.content),b.update_element_info()})}),molockup.content_menu.wrapInner("<ul/>").toggle("show").draggable(),!1}})})(jQuery)